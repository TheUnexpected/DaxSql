SELECT TOP 100* FROM NDC.VW_DWH_GrlProvisionBonos

SELECT
	Periodo,
	Nagente,
	CASE
		WHEN PolizaAnterior = 0 or PolizaAnterior is null THEN 'Nueva'
		Else 'Renovada'
	END Renovaciones,
	sum(emicion) emision,
	sum(Prima) Prima

FROM (
	SELECT 
		isnull(emision.NAgente,cancel.Nagente) as Nagente,
		isnull(emision.Periodo, cancel.Periodo) as Periodo,
		isnull(emision.PolSocioComercial,cancel.PolSocioComercial) as PolSocioComercial,
		isnull(emision.NPoliza,cancel.NPoliza) as NPoliza,
		isnull(emision.RamoSubramol,cancel.RamoSubramol) as RamoSubRamol,
		isnull(emision.Ftervigpol,cancel.Ftervigpol) as Ftervigpol,
		--isnull(emision.PolizaAnteriorHDI,cancel.PolizaAnteriorHDI) as PolizaAnterior,
		isnull(emision.emicion,0)+isnull(cancel.emicion,0) as emicion,
		isnull(emision.emitida,0)-isnull(cancel.Cancelada,0) as Prima

	
	FROM (
					SELECT gmm_emi.NAgente,
							LEFT(gmm_emi.femirbo,6) AS Periodo,
							gmm_emi.PolSocioComercial,
							gmm_emi.NPoliza,
							gmm_emi.RamoSubramol,
							gmm_emi.Ftervigpol,
							gmm_emi.PolizaAnteriorHDI,
							1 'emicion',
							sum(gmm_emi.Pma1) AS Emitida
			
					FROM TB_DWH_GMMEmitidoAcumulado_CargaDiaria AS gmm_emi 
					WHERE 	LEFT(gmm_emi.femirbo,6) BETWEEN 202401 AND 202407
					GROUP BY gmm_emi.NAgente,
							LEFT(gmm_emi.femirbo,6),
							gmm_emi.PolSocioComercial,
							gmm_emi.NPoliza,
							gmm_emi.RamoSubramol,
							gmm_emi.Ftervigpol,
							gmm_emi.PolizaAnteriorHDI
			) AS emision
			FULL JOIN (
					SELECT gmm_can.NAgente,
							LEFT(gmm_can.Fecha,6) AS Periodo,
							gmm_can.PolSocioComercial,
							gmm_can.NPoliza,
							LEFT(gmm_can.RamoSubramol,charindex(',',gmm_can.RamoSubramol)-1) AS RamoSubramol,
							gmm_can.Ftervigpol,
							gmm_can.PolizaAnteriorHDI,
							-1 'emicion',
							sum(gmm_can.Pma1) AS Cancelada
					FROM TB_DWH_GMMEmitidoCancelaciones_CargaDiaria AS gmm_can
					WHERE 	LEFT(gmm_can.Fecha,6) BETWEEN 202401 AND 202407
					GROUP BY 	gmm_can.NAgente,
							LEFT(gmm_can.Fecha,6),
							gmm_can.PolSocioComercial,
							gmm_can.NPoliza,
							LEFT(gmm_can.RamoSubramol,charindex(',',gmm_can.RamoSubramol)-1),
							gmm_can.Ftervigpol,
							gmm_can.PolizaAnteriorHDI
			) AS cancel
			ON emision.NAgente=cancel.NAgente
			AND emision.Periodo=cancel.Periodo
			AND emision.PolSocioComercial=cancel.PolSocioComercial
			AND emision.NPoliza=cancel.NPoliza
			AND emision.RamoSubramol=cancel.RamoSubramol
			AND emision.Ftervigpol=cancel.Ftervigpol
) gmm
GROUP BY 
Periodo,
	Nagente,
	CASE
		WHEN PolizaAnterior = 0 or PolizaAnterior is null THEN 'Nueva'
		Else 'Renovada'
	END 


SELECT 

age.nipperfilagente, cot.*

FROM
TB_BI_Dimagente age
LEFT JOIN Dshd.Vw_bi_GrlEmiCotizaciones_Estadistica cot
		ON age.nipperfilagente = cot.nipperfilagente
WHERE 
    --FechaCotizacion BETWEEN 20240801 and 20241031
    age.nipperfilagente in (4146,4169,4186,4220,4649,4655,4697,4969,4974,4993,50108,50170,50332,50388,50401,50443,50444,50447,50454,50459,50460,50464,50488,50613,50620,50657,50880,51043,51118,51176,51218,51571,51588,51919,52001,52011,52072,52231,52440,52441,52599,52791,53021,53061,53070,53118,53231,53412,53980,54026,54036,54040,54063,54107,54220,54280,54786,54889,54900,54952,54953,54960,54964,54972,55021,55072,55113,55114,55173,55180,55191,55192,55198,55233,55234,55236,55269,55283,55291,55297,55308,55364,55390,55393,55402,55411,55431,55480,55484,55487,55497,55501,55559,55577,55580,55592,55603,55605,55607,55619,55622,55642,55667,55725,55761,55801,55815,55858,55906,55909,55928,55930,55933,55934,55946,55949,55965,55973,55975,56038,56039,56053,56120,56136,56199,56247,56248,56312,56345,56388,56414,56428,56437,56438,56439,56526,56536,56572,56584,56594,56612,56621,56625,56632,56659,56668,56680,56690,56760,56766,56800,56811,56874,56880,56895,56926,56937,56949,57091,57111,57116,57153,57214,57224,57242,57291,57296,57359,57460,57464,57473,57489,57525,57526,57538,57550,57558,57622,57696,57714,57738,57773,57786,57837,57842,57856,57857,57896,57897,57951,57985,58010,58012,58040,58049,58061,58071,58074,58109,58118,58131,58146,58155,58187,58192,58195,58227,58328,58361,58369,58384,58385,58447,58483,58486,58497,58517,58519,58613,58617,58619,58622,58624,58654,58685,58810,58832,58848,58859,58882,58884,58920,58934,58938,58980,59013,59068,59127,59129,59142,59182,59192,59216,59237,59271,59323,59403,59413,59435,59450,59472,59507,59517,59531,59694,59714,59761,59796,59811,59830,59877,59905,60121,60259,60317,60349,60422,60432,60439,60455,60578,60616,60717,60740,60747,60929,60951,60952,61000,61001,61014,61039,61169,61185,61220,61223,61263,61287,61318,61351,61403,61407,61408,61488,61499,61577,61602,61646,61648,61756,61818,61850,63038,63078,63175,63203,63225,63318,63356,63357,63359,63392,63393,63394,63400,63403,63438,63461,63490,63762,63777,63788,63806,63888,63935,63938,63942,63954,63975,64024,64025,64171,64188,64189,64209,64213,64217,64254,64327,64330,64332,64347,64366,64371,64403,64545,64547,64555,64631,64642,64658,64852,64881,64933,65041,65129,65143,65145,65164,65172,65191,65265,65271,65291,65309,65320,65344,65345,65678,65688,65690,65724,65745,65758,65764,65779,65799,65808,65871,65881,65898,65899,65975,66022,66025,66034,66074,66078,66268,66299,66309,66313,66324,66347,66392,66393,66400,66420,66423,66426,66486,66613,66615,66652,66662,66726,66945,66962,67053,67107,67108,67109,67137,67213,67242,67288,67293,67300,67307,67328,67337,67340,67437,67513,67516,67590,67622,67627,67655,67688,67694,67734,67735,67745,67747,67753,67755,67785,67798,67799,67846,67848,67967,67980,68021,68023,68024,68123,68131,68142,68143,68169,68188,68197,68205,68234,68284,68286,68330,68471,68493,68496,68556,68559,68577,68583,68595,68600,68659,68685,68697,68869,69063,69066,69076,69090,69103,69107,69131,69139,69142,69151,69156,69187,69196,69329,69340,69350,69351,69396,69398,69421,69431,69434,69458,69484,69500,69541,69618,69628,69632,69651,69694,69708,69740,69744,69757,69761,69770,69797,69799,69805,69813,69816,69862,69864,69891,69900,69904,69905,69906,69915,69916,69919,69920,69933,69972,69989,69998,70241,70242,70265,70348,70349,70354,70367,70383,90002,90008,90024,90061,90101,90237,90293,90316,90335,90401,90476,90490,90492,90505,90508,90520,90525,90527,90568,90588,90594,90601,90606,90701,90708,90710,90712,90721,90729,90758,90775,90776,90777,90785,90799,90800,90814,90819,90837,90873,90900,90902,90950,90960,90965,90970,90978,90979,90980,91015,91016,91020,91030,91043,91058,91072,91100,91151,91185,91186,91195,91254,91335,91353,91381,91435,91437,91458,91634,91663,91673,91681,91699,91795,91802,91834,91847,91872,91889,91896,91901,91971,92000,92025,92041,92043,92044,92086,92105,92112,92141,92142,92148,92166,92180,92182,92184,92186,92192,92223,92230,92235,92249,92286,92310,92315,92320,92540,92542,92553,92563,92575,92622,92626,92643,92754,92760,92761,92763,92768,92778,92786,92790,92791,92795,92797,92816,92844,92853,92858,92879,92891,92973,92981,92996,93014,93015,93112,93154,93155,93172,93180,93205,93236,93271,93282,93286,93289,93296,93312,93317,93321,93323,93324,93338,93343,93352,93362,93371,93504,93549,93550,93552,93568,93569,93570,93602,93609,93610,93611,93630,93632,93633,93634,93640,93644,93659,93661,93686,93688,93720,93721,93722,93723,93727,93737,93738,93739,93748,93749,93750,93752,93753,93757,93758,93759,93761,93762,93763,93765,93766,93767,93768,93771,93778,93779,93791,93793,93795,93800,93803,93820,93830,93910,94224,94231,94234,94243,94277,94279,94281,94283,94292,94295,94334,94337,94338,94339,94345,94359,94360,94361,94365,94366,94430,94438,94442,94480,94506,94536,94539,94541,94552,94579,94595,94616,94630,94633,94634,94646,94667,94734,94735,94804,94826,94833,94851,94852,94869,94871,94877,94943,95325,95343,95345,95347,95365,95388,95401,95402,95408,95421,95423,95451,95536,95539,95558,95560,95574,95600,95601,95602,95605,95645,95668,95670,95675,95686,95692,95736,95756,95765,95785,95965,95969,95972,95998,96009,96010,96031,96044,96057,96071,96093,96095,96097,96099,96103,96104,96108,96115,96124,96132,96169,96188,96190,96200,96208,96209,96210,96211,96217,96743,96770,96860,96862,96879,96884,96926,96930,97093,97097,97131,97144,97167,97194,97195,97277,97292,97296,97302,97321,97323,97327,97342,97344,97354,97360,97363,97367,97380,97408,97427,97434,97454,97471,97504,97508,97519,97524,97565,97582,97623,97625,97626,97632,97671,97672,97673,97674,97676,97677,97678,97679,97680,97681,97682,97704,97706,97715,97736,97738,97745,97810,97817,98000,98002,98008,98027,98031,98032,98033,98034,98036,98051,98059,98063,98069,98075,98094,98098,98113,98122,98147,98156,98217,98226,98227,98248,98265,98266,98268,98271,98273,98288,98290,98296,98308,98325,98330,98338,98345,98378,98386,98387,98404,98408,98419,98599,98601,98611,98621,98622,98769,98946,98948,98950,98952,98954,98956,98957,98959,98998,99000,99025,99032,99041,99054,99060,99081,99088,99091,99092,99093,99096,99118,99131,99136,99152,99154,99165,99167,99188,99244,99262,99269,99281,99292,99293,99329,99334,99337,99344,99358,99359,99371,99406,99419,99430,99468,99470,99525,99636,99868,99947,100203,100268,100273,100305,100356,100365,100601,100671,100806,100816,100820,100822,100825,100826,100860,100876,100877,100878,100890,100901,101085,101131,101135,101137,101157,101176,101188,101548,101707,101709,101713,101745,101750,101805,101826,101832,101837,101838,101853,101854,101869,101870,101990,101995,102013,102017,102040,102053,102078,102118,102131,102132,102164,102167,102232,102238,102239,102240,102252,102254,102341,102560,102570,102598,102622,102623,102624,102632,102724,102783,102825,102836,102880,102883,102895,102903,102914,102954,102955,102956,102957,102981,102986,102987,102991,102997,102998,103024,103027,103034,103060,103069,103101,103141,103142,103152,103159,103232,103242,103244,103254,103255,103266,103283,103292,103295,103325,103326,103348,103371,103393,103395,103414,103424,103439,103440,103444,103461,103463,103469,103473,103499,103502,103511,103518,103528,103546,103548,103583,103626,103636,103652,103665,103676,103700,103701,103718,103722,103725,103727,103728,103729,103730,103731,103732,103734,103735,103736,103737,103738,103739,103740,103741,103742,103744,103745,103746,103747,103768,103769,103770,103771,103772,103773,103774,103775,103776,103777,103778,103780,103781,103782,103783,103784,103785,103786,103787,103788,103791,103792,103793,103794,103795,103796,103810,103816,103819,103820,103832,103835,103846,103852,103864,103865,103893,103903,103907,103909,103917,103921,103963,103970,103983,104004,104013,104036,104045,104065,104067,104068,104091,104095,104108,104113,104121,104126,104127,104129,104138,104156,104163,104170,104175,104208,104409,104484,104490,104506,104508,104509,104538,104601,104608,104612,104618,104625,104629,104636,104646,104671,104690,104692,104697,104698,104739,104753,104783,104795,104804,104820,104828,104832,104860,104899,104916,104932,104942,104946,104947,104948,104950,104951,104952,104955,104957,104963,104964,104965,104970,105000,105007,105019,105031,105032,105034,105061,105066,105068,105082,105091,105102,105103,105107,105108,105133,105134,105136,105155,105158,105163,105166,105193,105200,105221,105255,105284,105307,105309,105330,105340,105346,105348,105350,105371,105424,105447,105448,105548,105549,105585,105611,105614,105616,105641,105667,105683,105687,105712,105721,105722,105730,105734,105739,105740,105763,105764,105765,105766,105767,105768,105770,105771,105773,105774,105776,105777,105778,105780,105781,105783,105784,105785,105786,105787,105788,105789,105790,105791,105792,105794,105816,105818,105820,105821,105824,105837,105838,105839,105845,105853,105877,105878,105884,105892,105894,105899,105902,105926,105946,105957,105969,105970,105977,105979,105995,105996,106000,106007,106038,106055,106056,106058,106066,106077,106095,106101,106109,106117,106128,106136,106163,106181,106189,106202,106207,106209,106210,106214,106222,106237,106246,106258,106259,106265,106267,106275,106313,106315,106375,106379,106384,106399,106400,106402,106406,106530,106548,106557,106561,106565,106578,106581,106585,106589,106612,106614,106616,106618,106620,106694,106706,106722,106803,106868,106873,106890,106907,106912,106917,106942,107020,107026,107028,107047,107059,107060,107072,107079,107083,107089,107092,107096,107098,107109,107115,107117,107121,107123,107126,107130,107135,107145,107147,107152,107203,107210,107222,107225,107233,107236,107246,107250,107257,107264,107265,107267,107270,107299,107337,107340,107350,107351,107352,107361,107362,107363,107376,107378,107396,107413,107416,107417,107796,108011,108021,108022,108024,108046,108052,108058,108121,108138,108142,108164,108169,108175,108180,108183,108185,108245,108306,108311,108313,108317,108347,108348,108350,108351,108355,108360,108362,108364,108365,108403,108404,108442,108593,108597,108601,108606,108619,108624,108636,108672,108677,108689,108691,108698,108702,108703,108720,108729,108735,108744,108751,108761,108765,108778,108798,108799,108800,108801,108803,108804,108806,108807,108810,108811,108839,108844,108850,108851,108860,108861,108871,108893,108898,108899,108911,108915,108932,108933,109007,109120,109147,109148,109162,109166,109188,109241,109250,109253,109268,109362,109363,109364,109365,109366,109367,109368,109369,109370,109371,109372,109373,109383,109384,109396,109397,109437,109443,109453,109458,109472,109491,109511,109513,109516,109517,109531,109542,109546,109567,109569,109570,109576,109579,109582,109591,109626,109633,109644,109651,109652,109654,109666,109677,109678,109697,109699,109729,109745,109746,109767,109799,109824,109832,109834,109857,109858,109861,109869,109874,109889,109891,109893,109991,109995,110014,110057,110116,110142,110147,110151,110170,110174,110177,110189,110196,110197,110201,110210,110221,110231,110247,110415,110426,110431,110437,110448,110451,110487,110492,110508,110512,110527,110533,110589,110593,110712,110717,110724,110727,110896,110947,110949,111005,111015,111023,111027,111089,111238,111305,111407,111419,111425,111428,111457,111458,111468,111470,111485,111488,111489,111490,111491,111492,111494,111495,111496,111497,111498,111499,111500,111501,111502,111503,111504,111505,111506,111508,111509,111511,111512,111513,111515,111516,111518,111519,111520,111523,111524,111525,111531,111536,111538,111674,111694,111721,111723,111728,111730,111731,111733,111734,111738,111741,111783,111788,111792,111801,111804,111805,111834,111856,111873,111881,111913,111914,111923,111957,111961,111983,111999,112001,112036,112091,112095,112096,112097,112099,112101,112102,112103,112104,112111,112115,112138,112142,112152,112156,112200,112236,112243,112247,112254,112285,112300,112306,112310,112324,112334,112350,112368,112371,112372,112375,112398,112399,112401,112402,112404,112412,112422,112436,112450,112455,112456,112457,112466,112479,112480,112484,112487,112494,112506,112512,112517,112626,112634,112635,112636,112637,112663,112665,112680,112686,112697,112699,112701,112713,112738,112739,112749,112762,112795,112803,112820,112823,112829,112839,112841,112842,112844,112847,112848,112849,112968,112969,112971,112976,112977,112979,112980,112981,112982,112983,112984,112985,112986,112987,112988,112990,112991,112992,113036,113038,113044,113045,113046,113047,113048,113049,113069,113071,113078,113080,113082,113085,113096,113124,113144,113157,113158,113198,113321,113322,113354,113358,113359,113361,113365,113388,113402,113403,113406,113407,113410,113416,113440,113442,113443,113444,113445,113465,113469,113471,113472,113483,113491,113492,113500,113503,113505,113507,113508,113522,113523,113525,113526,113527,113529,113530,113531,113532,113533,113534,113536,113539,113540,113541,113542,113543,113544,113546,113547,113548,113549,113550,113553,113554,113556,113557,113558,113559,113560,113562,113564,113565,113566,113567,113568,113569,113571,113573,113574,113576,113577,113578,113579,113580,113581,113582,113585,113587,113588,113589,113591,113592,113594,113595,113596,113597,113598,113599,113600,113602,113603,113604,113605,113606,113610,113612,113614,113615,113616,113617,113618,113619,113621,113622,113623,113624,113627,113631,113632,113635,113637,113638,113640,113641,113642,113643,113644,113646,113647,113648,113653,113654,113655,113656,113657,113658,113659,113661,113662,113664,113665,113666,113667,113668,113669,113670,113672,113673,113674,113676,113679,113680,113682,113684,113685,113686,113687,113688,113689,113690,113691,113692,113693,113694,113695,113696,113697,113699,113700,113702,113703,113704,113706,113707,113708,113709,113710,113711,113712,113713,113726,113737,113738,113753,113754,113755,113756,113764,113770,113782,113785,113791,113801,113815,113816,113817,113818,113819,113820,113826,113827,113847,113856,113865,113869,113875,113889,113898,113899,113906,113926,113931,113933,113970,113971,113972,113973,113990,113994,113996,113997,114032,114050,114053,114054,114056,114057,114058,114062,114063,114065,114066,114073,114076,114077,114080,114083,114084,114085,114089,114098,114100,114104,114106,114127,114131,114132,114134,114135,114137,114150,114151,114153,114154,114161,114184,114185,114217,114218,114227,114232,114243,114283,114319,114323,114327,114329,114330,114350,114351,114371,114385,114387,114415,114454,114473,114482,114493,114496,114497,114501,114503,114510,114517,114521,114522,114524,114529,114532,114533,114538,114540,114541,114570,114589,114590,114592,114594,114603,114619,114628,114637,114638,114640,114641,114647,114653,114698,114757,114759,114773,114774,114783,114786,114788,114791,114793,114795,114796,114810,114822,114823,114825,114839,114851,114852,114860,114861,114874,114876,114886,114888,114902,114922,114923,114927,114928,114932,114945,114971,114981,115009,115011,115023,115038,115039,115049,115053,115060,115062,115063,115074,115082,115086,115090,115096,115099,115102,115117,115118,115133,115139,115143,115155,115156,115158,115161,115170,115172,115189,115190,115211,115216,115218,115219,115221,115237,115246,115288,115296,115297,115298,115303,115306,115308,115317,115324,115330,115339,115340,115342,115347,115350,115355,115360,115361,115365,115376,115381,115387,115426,115430,115433,115474,115478,115485,115518,115523,115561,115562,115563,115566,115573,115575,115581,115590,115596
)
and cot.idoficina is null

SELECT MIN(FemiRbo) FROM dbo.TB_DWH_GMMCEmitidoAcumulado_CargaDiaria AS emi_c where PolizaAnteriorHDI is not null
SELECT * FROM TB_DWH_GMMEmitidoCancelaciones_CargaDiaria AS gmm_can